#!/bin/sh
nowdate=$(date +%Y-%m-%d)


qsl='{
  "_source":{
    "excludes":["messages","message"]
  },
  "query": {
    "bool": {
      "must": [
        {"term": {
          "type": {
            "value": "aud"
          }
        }},
        {"range": {
          "logtime": {
            "gte": "#today#",
            "lte": "now",
            "format": "yyyy-MM-dd"
          }
        }},
        {
          "bool": {
      "should": [
        {
          "match_phrase": {
            "action": "LOGOFF"
          }
        },
        {
          "match_phrase": {
            "action": "LOGOFF BY CLEANUP"
          }
        }
      ],
      "minimum_should_match": 1
    }

        }

      ]

    }
  },
  "aggs": {
    "byhost": {
      "terms": {
        "field": "bimap.host",
        "size": 1000
      },
      "aggs": {
        "bysname": {
          "terms": {
            "field": "service_name",
            "size": 100
          },
          "aggs": {
            "byuid": {
              "terms": {
                "field": "userid",
                "size": 10
              },
              "aggs": {
                "lread": {
                  "sum": {
                    "field": "logoff_lread"
                  }
                },
                "lwrite":{
                  "sum": {
                    "field": "logoff_lwrite"
                  }
                }
              }
            }
          }
        }

      }
    }
  }
}'
    

echo ${qsl//#today#/${nowdate}} > /tmp/oracle_logoff.json
index=bimap-sa-oracle-*
url=http://84.239.18.43:9200
curl -X GET -u readonly:123456 ${url}/${index}/_search  -H 'Content-Type: application/json' -d @/tmp/oracle_logoff.json > oracle_logoff.json

python esJson2csv.py -jsonfile oracle_logoff.json getagg -glist byhost,bysname,byuid -vlist lread,lwrite > ORACLE_LOGOFF.CSV
